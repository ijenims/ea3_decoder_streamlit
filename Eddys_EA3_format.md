メーカー仕様書との突き合わせと、実データ解析（フッターの文字化け原因特定）の結果を反映して、**EA3ファイルフォーマット仕様書（確定版）** を作成しました。

これを `Eddys_EA3_format.md` などの名前で保存しておくと、将来的なメンテナンスやチームへの共有に役立ちます。

---

# EA3 ファイルフォーマット仕様書 (Rev. 2)

**最終更新日:** 2025/12/05
**対象機器:** EddyStation ほか同系統の渦電流探傷装置

## 1. ファイル概要
*   **拡張子**: `.ea3`
*   **エンディアン**: リトルエンディアン (Little Endian)
*   **文字コード**: Shift_JIS (タイトル・コメント部)

## 2. データ構造全体図

ファイルは「ヘッダー」「波形データ」「フッター（付帯情報）」の3ブロックで構成される。

| ブロック | 開始オフセット | サイズ | 内容 |
| :--- | :--- | :--- | :--- |
| **Header** | `0x0000` | 256 bytes | データ点数、サンプリングレート等のメタ情報 |
| **Data** | `0x0100` | 可変 | 計測波形データ (X, Y) |
| **Footer** | 可変 | 可変 | 区切り文字、タイトル、コメント、画像データ |

---

## 3. ヘッダー詳細 (Offset `0x00` - `0x0FF`)

| Offset | 型 | サイズ | 項目名 | 説明 |
| :--- | :--- | :--- | :--- | :--- |
| `+0` | Char[] | 8 | File Signature | `UNIESSW` 等の識別子 |
| `+8` | UInt32 | 4 | **データブロック数 (N)** | 波形データの総ブロック数。<br>※ **実データ点数は `N-1` 点** であることが多い（末尾1ブロックは区切り文字領域のため）。 |
| `+16` | UInt16 | 2 | **サンプリングレート** | 単位: Hz (例: 20 = 20Hz) |
| `+18` | UInt8 | 1 | **チャンネル数** | 計測チャンネル数 (通常は `1`) |
| `+20` | Byte[] | 16 | チャンネル設定 | 各CHの波形タイプ指定 (1:F1, 2:F2, 3:ABS, 4:MIX...) |
| ... | ... | ... | (予約領域) | `0x00` 埋め |

---

## 4. 波形データ領域 (Offset `0x0100` 〜)

*   **開始位置**: `0x0100` (256バイト目)
*   **データ構造**: 1サンプルあたり4バイト（X成分 2byte + Y成分 2byte）
*   **データ型**: `Int16` (符号付き16bit整数)

### メモリマップ
チャンネル数 = 1 の場合：

| 相対オフセット | 型 | 内容 |
| :--- | :--- | :--- |
| `+0` | Int16 | データ1点目: **X成分** |
| `+2` | Int16 | データ1点目: **Y成分** |
| `+4` | Int16 | データ2点目: **X成分** |
| `+6` | Int16 | データ2点目: **Y成分** |
| ... | ... | ... |

### 物理量変換（スケーリング）
バイナリ値を電圧(V)に変換する式は以下の通り。

$$ Voltage [V] = \frac{\text{RawValue}}{3276.8} $$

*   `32767` $\rightarrow$ `+9.999 V` (約10V)
*   `-32768` $\rightarrow$ `-10.000 V`

> **補足**: メーカー仕様書にある「1変わると 20/4096 V 変化」という記述は、12bit分解能機種の記述が残っている誤記の可能性が高いため無視する。

---

## 5. フッター領域 (タイトル・コメント)

波形データの直後に、可変長のテキスト情報が格納されている。
読み込み開始位置は `0x0100 + (データブロック数 N-1) * 4` 付近となる。

### 区切り文字 (Magic Number)
波形データとタイトルの境界に、4バイトの特殊な数値が挿入されている場合がある。

| データ | 16進表記 | 説明 | 処理方法 |
| :--- | :--- | :--- | :--- |
| **305419896** | `0x12345678` | 境界マーカー | この値が出現した場合、**読み飛ばして**次のデータを読み込む。 |

### テキストデータ構造
区切り文字の直後から以下の構造が続く。

1.  **タイトル文字数** (UInt32, 4バイト)
2.  **タイトル文字列** (Shift_JIS, 可変長)
3.  **コメント文字数** (UInt32, 4バイト)
4.  **コメント文字列** (Shift_JIS, 可変長)

※ 文字数が `0` の場合は文字列データは存在せず、次の項目（コメント文字数など）が直後に続く。

---

## 6. 実装時の注意点

1.  **データ点数の補正**
    ヘッダー(+8)の値が `493` の場合、実際の有効データは `492` 点である。残り1点分（4バイト）の領域には、上記「区切り文字 (`0x12345678`)」が格納されていることが多い。
    実装時は `有効点数 = HeaderValue - 1` として扱うのが安全である。

2.  **画像データ (BMP)**
    本仕様書範囲外だが、コメントデータ等の後ろに `COLORBMP` というヘッダーを持つビットマップ画像が連結されている場合がある。解析時はファイルの末尾まで不用意に読み込まないよう注意すること。